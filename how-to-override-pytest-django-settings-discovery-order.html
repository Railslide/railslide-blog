<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Railslide, Code, experiments, and thoughts">

        <link rel="alternate"  href="https://railslide.io/feeds/all.atom.xml" type="application/atom+xml" title="Railslide Full Atom Feed"/>

        <title>How to override pytest-django settings discovery order // Railslide // Code, experiments, and thoughts</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://railslide.io/theme/css/puremorning.css">
    <link rel="stylesheet" href="https://railslide.io/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <h1 class="brand-main"><a href="/">Railslide</a></h1>
                            <p class="tagline">Code, experiments, and thoughts</p>
                                <p class="links"><a href="/about.html">About</a></p>
                                <p class="links"><a href="/categories.html">Categories</a></p>
                                <p class="social">
                                    <a href="https://github.com/Railslide/">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                    <a href="feeds/all.atom.xml">
                                        <i class="fa fa-rss fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>How to override pytest-django settings discovery order</h1>
                        <p class="post-meta">
                        category: <a href="https://railslide.io/category/dev.html">dev</a>, date: 29-09-2016
                        </p>
                        <p class="post-meta">
                            tags =                                 <a class="post-category" href="https://railslide.io/tag/django.html">django</a>
                                <a class="post-category" href="https://railslide.io/tag/pytest.html">pytest</a>
                                <a class="post-category" href="https://railslide.io/tag/pytest-django.html">pytest-django</a>
                                <a class="post-category" href="https://railslide.io/tag/environment-variables.html">environment variables</a>
                </header>
            </section>
            <p>If you want to use Pytest for running the test suite in your Django project, all you need to do is to install pytest-django, tell it where to look for the Django settings file - usually by placing a <code>pytest.ini</code> file in the project root folder - and you're ready to go. However, even though the <code>pytest.ini</code> file is probably the most common way to point pytest-django to the settings file, it also the last place in which pytest-django will look for it. In fact, every time you run <code>pytest</code>, pytest-django will check for the <code>DJANGO_SETTINGS_MODULE</code> variable in the following order:</p>
<ul>
<li>command line option with <code>--ds</code></li>
<li>environment variables</li>
<li><code>pytest.ini</code> file</li>
</ul>
<p>While this order would work perfectly fine for many projects, if you happen to have an enviroment variable pointing to a different settings file (e.g. if you're running your project in a Docker container), it might reveals itself as a bit of a bummer. So, what are the available options for preventing django-pytest from picking up the wrong variable?</p>
<h2>Using the <code>--ds</code> option</h2>
<p>This is probably a no-brainer, but the most obvious way to make sure pytest-django picks up the right settings file is to pass the <code>--ds</code> option when invoking <code>pytest</code> from the command line.</p>
<p>While it certainly works, it adds quite a lot of typing - especially if you use a <a href="https://www.rdegges.com/2011/the-perfect-django-settings-file/">settings module instead of a single setting file</a>, since it could easily translate into</p>
<div class="highlight"><pre><span></span><code>$ pytest --ds<span class="o">=</span>project_folder.settings_folder.settings_file
</code></pre></div>

<p>Certainly not something I'd like to do every time I want to run the test suite.</p>
<h2>Setting the environment variable</h2>
<p>Another way around the issue is to set the environment variable to the test settings file before every test run and the setting it back to its original value once you're finished.</p>
<p>However, besides still requiring quite a lot of typing, this method is also extremely error prone. What if you forget to set the environment variable back after test running? So, unless you're willing to take the risk of frustrating debugging time trying to figure out why your app is not working as it should, this option is pretty much a no-op.</p>
<h2>Using <code>addopts</code> in the <code>pytest.ini</code> file</h2>
<p>Wouldn't be awesome if you could just use the <code>pytest.ini</code> file, set all the necessary settings in there, and not have to worry ever again? Actually you can, thanks to <a href="http://doc.pytest.org/en/3.0.2/customize.html#confval-addopts"><code>addopts</code></a>.</p>
<p>What <code>addopts</code> does is to add options (hence the double d!) to your test run as if they were specified via command line. So, for example, if you want to update and export coverage every time you run the suite, you would write this in the <code>pytest.ini</code> file</p>
<div class="highlight"><pre><span></span><code><span class="k">[pytest]</span><span class="w"></span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">.</span><span class="w"></span>
<span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">html</span><span class="w"></span>
</code></pre></div>

<p>and every time you run <code>pytest</code> it will, behind the scene, be interpreted as if you have run</p>
<div class="highlight"><pre><span></span><code>$ pytest --cov<span class="o">=</span>. --cov-report<span class="o">=</span>html
</code></pre></div>

<p>Thus, by adding <code>--ds=project_folder.settings_folder.settings_file</code> to <code>addopts</code> it is possible to override pytest-django discovery order and make sure that the value in the <code>pytest.ini</code> file gets read instead of environment variable.</p>
<p>Ok, but what if you want to point pytest to a different settings file for one run only? No problem! One of the perks of this method is that you can esplicitly pass the <code>--ds</code> option from the command line to override the one in the <code>pytest.ini</code> file. So running</p>
<div class="highlight"><pre><span></span><code>$ pytest --ds<span class="o">=</span>other_settings_file
</code></pre></div>

<p>will just work as usual. Neat!</p>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; Railslide <a href="http://creativecommons.org/licenses/by-sa/4.0/">(CC BY-SA 4.0)</a> &ndash;
        Built with <a href="http://blog.getpelican.com/">Pelican</a>
        and a modified version of <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>